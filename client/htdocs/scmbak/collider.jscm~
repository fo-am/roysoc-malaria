;; -*- mode: scheme; -*-
;; Viruscraft Copyright (C) 2017 FoAM Kernow

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; population stuff

(define (protein prim points)
  (list prim points))

(define (protein-prim p) (list-ref p 0))
(define (protein-points p) (list-ref p 1))

(define iso (load-primitive "models/isotest.obj"))

(define (build-protein type)
  (let ((p (with-state (build-instance iso)))
	(points (list (vector 0.3 0 0) (vector 0 0.3 0))))
    (with-state
     (parent p)
     (for-each
      (lambda (point)
    	(with-state
    	 (colour (vector 1 0 0))
    	 (translate point)
    	 (scale (vector 0.1 0.1 0.1))
    	 (build-instance iso)))
      points))
    (protein p points)))
  
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(set-camera-transform 
  (mat4.rotateY
   (mat4.rotateX
    (mat4.translate 
     (mat4.identity (mat4.create))
     (vector 0 0 -15))
    0.6)
   0))

(define prot (with-state
 (texture (load-texture "white.png"))
 (scale (vector 3 3 3))
 (build-protein)))

(with-state
 (translate (vector -4 0 0))
 (build-cube))

(define (render)
  (with-primitive 
   iso
    (pdata-map! 
     (lambda (p) 
       (vadd p (vmul (crndvec) 0.02)))
     "p"))

  (set-camera-transform (mat4.rotateY (camera-transform) 0.002)))

(every-frame (render))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; startup

(define (read-number id)
  (let ((w ($ (string-append "#" id))))
    (parseFloat (js "w[0].value"))))


(set! rebuild 
      (lambda () 
	(clear)
	(set! insect-list (build-list 5 (lambda (i) (build-insect))))
	(set! plant-list (plants-build-connections (build-list 30 (lambda (i) (build-plant i)))))))


(set! update-params 
      (lambda ()
	(set! insect-sirs-model 
	      (make-model
	       (read-number "i-background")
	       (read-number "i-infection")
	       (read-number "i-recovery")
	       (read-number "i-susceptability")))
	(set! plant-sirs-model 
	      (make-model
	       (read-number "p-background")
	       (read-number "p-infection")
	       (read-number "p-recovery")
	       (read-number "p-susceptability")))))

